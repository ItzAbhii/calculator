import json, random, time, os, sys

try:
    import pyttsx3
    engine = pyttsx3.init()
    engine.setProperty('rate', 150)
except:
    engine = None

VOICE_MODE = False
PROFILE_FILE = "profile.json"

def speak(text):
    if VOICE_MODE and engine:
        engine.say(text)
        engine.runAndWait()

def save_profile(profile):
    with open(PROFILE_FILE, "w") as f:
        json.dump(profile, f)

def load_profile():
    if os.path.exists(PROFILE_FILE):
        with open(PROFILE_FILE) as f:
            return json.load(f)
    return {"name": "Player", "xp": 0}

profile = load_profile()

def clear():
    os.system('cls' if os.name == 'nt' else 'clear')

def pause():
    input("\nPress Enter to continue...")

# Calculator Functions
def calculator():
    clear()
    print("✨ Advanced Calculator Mode ✨")
    speak("Welcome to Advanced Calculator!")
    ops = {'+': lambda x,y: x+y, '-': lambda x,y: x-y,
           '*': lambda x,y: x*y, '/': lambda x,y: x/y if y != 0 else "No divide by zero!",
           '**': lambda x,y: x**y, '%': lambda x,y: x%y}
    while True:
        try:
            expr = input("Enter calculation (or 'exit'): ")
            if expr.lower() == 'exit':
                break
            # simple safe eval replacement:
            for op in ops:
                if op in expr:
                    left,right = expr.split(op)
                    left,right = float(left.strip()), float(right.strip())
                    result = ops[op](left,right)
                    print(f"= {result}")
                    speak(f"Result is {result}")
                    break
            else:
                print("Use operators +, -, *, /, **, % only!")
        except Exception as e:
            print(f"Oops! {e}")

# Minigames:

def minigame_guess():
    clear()
    print("🎯 Guess the Number Game 🎯")
    speak("Guess the number game, guess a number 1 to 100")
    target = random.randint(1, 100)
    tries = 0
    while True:
        guess = input("Guess: ")
        if not guess.isdigit():
            print("Numbers only, bro.")
            continue
        guess = int(guess)
        tries += 1
        if guess < target:
            print("Too low!")
        elif guess > target:
            print("Too high!")
        else:
            print(f"Yooo! You got it in {tries} tries!")
            speak(f"You won in {tries} tries!")
            break
    pause()

def minigame_rps():
    clear()
    print("✊ Rock Paper Scissors 🖐️")
    speak("Rock Paper Scissors")
    choices = ['rock','paper','scissors']
    while True:
        user = input("Choose rock/paper/scissors (or quit): ").lower()
        if user == 'quit':
            break
        if user not in choices:
            print("Nah, pick rock, paper, or scissors.")
            continue
        comp = random.choice(choices)
        print(f"Computer: {comp}")
        if user == comp:
            print("Tie!")
        elif (user=='rock' and comp=='scissors') or (user=='paper' and comp=='rock') or (user=='scissors' and comp=='paper'):
            print("You win!")
        else:
            print("You lose!")
    pause()

def minigame_typing():
    clear()
    print("⌨️ Typing Speed Test ⌨️")
    sentence = "The quick brown fox jumps over the lazy dog"
    print(sentence)
    speak("Typing test")
    input("Press enter to start...")
    start = time.time()
    typed = input()
    end = time.time()
    if typed.strip() == sentence:
        print(f"Nice! {end - start:.2f} seconds")
    else:
        print("Nope, not the same.")
    pause()

def minigame_tictactoe():
    clear()
    print("🎲 Tic Tac Toe 🎲")
    speak("Tic Tac Toe")
    board = [' ']*9
    def show():
        print(f"{board[0]}|{board[1]}|{board[2]}")
        print("-+-+-")
        print(f"{board[3]}|{board[4]}|{board[5]}")
        print("-+-+-")
        print(f"{board[6]}|{board[7]}|{board[8]}")
    def win(p):
        wins = [(0,1,2),(3,4,5),(6,7,8),(0,3,6),(1,4,7),(2,5,8),(0,4,8),(2,4,6)]
        return any(all(board[i]==p for i in w) for w in wins)
    def player_move():
        while True:
            try:
                pos = int(input("Choose 1-9: ")) - 1
                if board[pos] == ' ':
                    board[pos] = 'X'
                    break
                else:
                    print("Taken spot!")
            except:
                print("Pick 1-9!")
    def comp_move():
        spots = [i for i,v in enumerate(board) if v==' ']
        if spots:
            board[random.choice(spots)] = 'O'
    while True:
        show()
        player_move()
        if win('X'):
            show()
            print("You won! 🎉")
            speak("You won!")
            break
        comp_move()
        if win('O'):
            show()
            print("You lost :(")
            speak("You lost!")
            break
        if ' ' not in board:
            show()
            print("Draw!")
            speak("Draw!")
            break
    pause()

def minigame_mathquiz():
    clear()
    print("🧠 Math Quiz 🧠")
    speak("Math Quiz")
    score = 0
    for i in range(5):
        a,b = random.randint(1,20), random.randint(1,20)
        op = random.choice(['+','-','*'])
        ans = eval(f"{a}{op}{b}")
        try:
            guess = float(input(f"{a} {op} {b} = "))
            if guess == ans:
                print("Correct!")
                score += 1
            else:
                print(f"Wrong, it's {ans}")
        except:
            print(f"Not a number. Answer was {ans}")
    print(f"Score: {score}/5")
    pause()

def minigame_memory():
    clear()
    print("🧠 Memory Game 🧠")
    speak("Memory Game")
    seq = [random.choice('ABCDEF') for _ in range(5)]
    print("Remember:", " ".join(seq))
    time.sleep(3)
    clear()
    guess = input("Sequence: ").upper()
    if guess == "".join(seq):
        print("Perfect!")
    else:
        print(f"Nope, it was {''.join(seq)}")
    pause()

def minigame_diceroll():
    clear()
    print("🎲 Dice Roll 🎲")
    speak("Dice Roll")
    input("Hit Enter to roll dice...")
    print(f"You rolled a {random.randint(1,6)}")
    pause()

def minigame_scramble():
    clear()
    print("🔤 Word Scramble 🔤")
    speak("Word Scramble")
    words = ["python","calculator","gaming","challenge","program"]
    word = random.choice(words)
    scrambled = "".join(random.sample(word,len(word)))
    print("Unscramble:", scrambled)
    guess = input("Your guess: ").lower()
    if guess == word:
        print("Right on!")
    else:
        print(f"Wrong, it was {word}")
    pause()

def minigame_shooter():
    clear()
    print("🔫 Simple Shooter 🔫")
    speak("Simple Shooter")
    score = 0
    for _ in range(5):
        target = random.choice(["enemy","friend"])
        action = input("Shoot or skip? ").lower()
        if action == 'shoot':
            if target == "enemy":
                score += 1
                print("Hit! +1")
            else:
                score -= 1
                print("Oops, hit friend! -1")
        else:
            print("Skipped")
    print(f"Score: {score}")
    pause()

def boss_fight():
    clear()
    print("🔥 Boss Fight 🔥")
    speak("Boss fight time")
    player_hp = 100
    boss_hp = 150
    while player_hp > 0 and boss_hp > 0:
        print(f"Your HP: {player_hp} | Boss HP: {boss_hp}")
        move = input("Attack with slash/fireball/heal: ").lower()
        if move == 'slash':
            dmg = random.randint(10,25)
            boss_hp -= dmg
            print(f"You dealt {dmg} damage!")
        elif move == 'fireball':
            dmg = random.randint(15,30)
            boss_hp -= dmg
            player_hp -= 5  # fireball costs health
            print(f"Fireball hit {dmg}, but you lost 5 HP")
        elif move == 'heal':
            heal = random.randint(15,25)
            player_hp += heal
            print(f"Healed {heal} HP!")
        else:
            print("Invalid move")
            continue
        if boss_hp <= 0:
            print("Boss defeated! You win! 🎉")
            speak("Boss defeated! You win!")
            break
        boss_attack = random.randint(10,20)
        player_hp -= boss_attack
        print(f"Boss hits you for {boss_attack} damage!")
        if player_hp <= 0:
            print("You lost the boss fight! Try again.")
            speak("You lost the boss fight!")
            break
    pause()

# Main menu & profile
def main_menu():
    global VOICE_MODE
    while True:
        clear()
        print(f"Yo {profile['name']}! XP: {profile['xp']}")
        print("1. Calculator Mode")
        print("2. Play Minigames")
        print("3. Boss Fight")
        print("4. Toggle Voice Mode (currently: " + ("ON" if VOICE_MODE else "OFF") + ")")
        print("5. Change Name")
        print("6. Quit")
        choice = input("Pick: ")
        if choice == '1':
            calculator()
        elif choice == '2':
            minigames_menu()
        elif choice == '3':
            boss_fight()
        elif choice == '4':
            VOICE_MODE = not VOICE_MODE
            print("Voice Mode " + ("Enabled" if VOICE_MODE else "Disabled"))
            pause()
        elif choice == '5':
            name = input("Enter new name: ")
            if name.strip():
                profile['name'] = name.strip()
                save_profile(profile)
        elif choice == '6':
            save_profile(profile)
            print("Catch ya later! 👋")
            break
        else:
            print("Pick a valid number.")
            pause()

def minigames_menu():
    while True:
        clear()
        print("Pick a minigame:")
        print("1. Guess the Number")
        print("2. Rock Paper Scissors")
        print("3. Typing Speed Test")
        print("4. Tic Tac Toe")
        print("5. Math Quiz")
        print("6. Memory Game")
        print("7. Dice Roll")
        print("8. Word Scramble")
        print("9. Simple Shooter")
        print("0. Back to Main Menu")
        choice = input("Pick: ")
        if choice == '1': minigame_guess()
        elif choice == '2': minigame_rps()
        elif choice == '3': minigame_typing()
        elif choice == '4': minigame_tictactoe()
        elif choice == '5': minigame_mathquiz()
        elif choice == '6': minigame_memory()
        elif choice == '7': minigame_diceroll()
        elif choice == '8': minigame_scramble()
        elif choice == '9': minigame_shooter()
        elif choice == '0': break
        else:
            print("Pick a valid number.")
            pause()

if __name__ == "__main__":
    if profile['name'] == "Player":
        profile['name'] = input("What's your name? ").strip() or "Player"
        save_profile(profile)
    main_menu()
